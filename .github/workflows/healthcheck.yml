name: Healthcheck

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  probe:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Probe endpoints
        env:
          API_TOKEN: ${{ secrets.API_TOKEN }}
        run: |
          set -euo pipefail

          timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          auth_header=()
          if [ -n "${API_TOKEN:-}" ]; then
            auth_header=( -H "Authorization: Bearer ${API_TOKEN}" )
          fi

          probe() {
            local name=$1
            local url=$2
            local result
            result=$(curl -sS -o /dev/null -w "%{http_code} %{time_total}" "${auth_header[@]}" "$url" || true)
            local code time
            code=$(awk '{print $1}' <<<"$result")
            time=$(awk '{print $2}' <<<"$result")
            if [ -z "$code" ]; then
              code="000"
              time="0"
            fi
            printf '%s|%s|%s\n' "$name" "$code" "$time"
          }

          mkdir -p health_out
          {
            probe "swagger" "https://mriqc.nimh.nih.gov/"
            probe "t1w" "https://mriqc.nimh.nih.gov/api/v1/T1w"
            probe "bold" "https://mriqc.nimh.nih.gov/api/v1/bold"
          } > health_out/raw.txt

          python - <<'PY'
import json
from datetime import datetime, timezone

status = "OK"
endpoints = []

with open("health_out/raw.txt") as handle:
    for line in handle:
        name, code, duration = line.strip().split("|")
        code_int = int(code) if code.isdigit() else 0
        endpoints.append(
            {
                "name": name,
                "url": {
                    "swagger": "https://mriqc.nimh.nih.gov/",
                    "t1w": "https://mriqc.nimh.nih.gov/api/v1/T1w",
                    "bold": "https://mriqc.nimh.nih.gov/api/v1/bold",
                }[name],
                "status_code": code_int,
                "duration_seconds": float(duration),
                "ok": 200 <= code_int < 400,
            }
        )
        if not (200 <= code_int < 400):
            status = "WARN"

payload = {
    "status": status,
    "since": datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%SZ"),
    "endpoints": endpoints,
}

with open("health_out/status.json", "w", encoding="utf-8") as handle:
    json.dump(payload, handle, indent=2, sort_keys=True)
PY

          python - <<'PY'
import json
from datetime import datetime, timezone

with open("health_out/status.json", encoding="utf-8") as handle:
    payload = json.load(handle)

now = datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%SZ")
status = payload["status"]

rows = "\n".join(
    """<tr>
        <td>{name}</td>
        <td><a href=\"{url}\">{url}</a></td>
        <td>{code}</td>
        <td>{duration:.3f}s</td>
        <td>{ok}</td>
      </tr>""".format(
        name=item["name"],
        url=item["url"],
        code=item["status_code"],
        duration=item["duration_seconds"],
        ok="OK" if item["ok"] else "WARN",
    )
    for item in payload["endpoints"]
)

html = f"""<!doctype html>
<html lang=\"en\">
  <head>
    <meta charset=\"utf-8\" />
    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />
    <title>MRIQC Healthcheck</title>
    <style>
      body {{ font-family: sans-serif; margin: 2rem; }}
      .status {{ font-weight: bold; }}
      table {{ border-collapse: collapse; width: 100%; margin-top: 1rem; }}
      th, td {{ border: 1px solid #ddd; padding: 0.5rem; text-align: left; }}
      th {{ background: #f5f5f5; }}
    </style>
  </head>
  <body>
    <h1>MRIQC API Health</h1>
    <p class=\"status\">Overall status: {status}</p>
    <p>Since: {payload['since']}</p>
    <p>Updated: {now}</p>
    <table>
      <thead>
        <tr>
          <th>Endpoint</th>
          <th>URL</th>
          <th>Status Code</th>
          <th>Duration</th>
          <th>Result</th>
        </tr>
      </thead>
      <tbody>
        {rows}
      </tbody>
    </table>
  </body>
</html>
"""

with open("health_out/index.html", "w", encoding="utf-8") as handle:
    handle.write(html)
PY

      - name: Publish to gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          git fetch origin gh-pages || true
          if git show-ref --quiet refs/remotes/origin/gh-pages; then
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf .
          fi

          mkdir -p health
          cp health_out/index.html health/index.html
          cp health_out/status.json health/status.json

          if git diff --quiet; then
            echo "No changes to publish."
            exit 0
          fi

          git add health/index.html health/status.json
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git commit -m "chore(healthcheck): update status page"
          git push origin gh-pages
