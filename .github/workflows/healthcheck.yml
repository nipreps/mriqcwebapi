name: Healthcheck

"on":
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write

jobs:
  probe:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Probe endpoints
        env:
          API_TOKEN: ${{ secrets.API_TOKEN }}
        run: |
          set -euo pipefail

          auth_header=()
          if [ -n "${API_TOKEN:-}" ]; then
            auth_header=( -H "Authorization: Bearer ${API_TOKEN}" )
          fi

          probe() {
            local name=$1
            local url=$2
            local result
            result=$(curl -sS -o /dev/null -w "%{http_code} %{time_total}" "${auth_header[@]}" "$url" || true)
            local code time
            code=$(awk '{print $1}' <<<"$result")
            time=$(awk '{print $2}' <<<"$result")
            if [ -z "$code" ]; then
              code="000"
              time="0"
            fi
            printf '%s|%s|%s\n' "$name" "$code" "$time"
          }

          mkdir -p health_out
          {
            probe "swagger" "https://mriqc.nimh.nih.gov/"
            probe "t1w" "https://mriqc.nimh.nih.gov/api/v1/T1w"
            probe "bold" "https://mriqc.nimh.nih.gov/api/v1/bold"
          } > health_out/raw.txt

          python test/healthcheck_status.py health_out/raw.txt health_out/status.json
          python test/healthcheck_render.py health_out/status.json health_out/index.html

      - name: Compute health status
        id: health_status
        run: |
          set -euo pipefail

          python - <<'PY'
          import json
          import os

          with open("health_out/status.json", encoding="utf-8") as handle:
              payload = json.load(handle)

          status = "OK"
          for endpoint in payload.get("endpoints", []):
              if not endpoint.get("ok", False):
                  status = "FAIL"
                  break

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as handle:
              handle.write(f"status={status}\n")
          PY

      - name: Publish to gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          git fetch origin gh-pages || true
          if git show-ref --quiet refs/remotes/origin/gh-pages; then
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf .
          fi

          previous_status=""
          if [ -f health/status.json ]; then
            previous_status=$(jq -r '.status // "UNDEFINED"' health/status.json)
          fi

          new_status="${{ steps.health_status.outputs.status }}"
          if [ "$previous_status" = "WARN" ]; then
            previous_status="FAIL"
          fi
          if [ "${previous_status:-UNDEFINED}" = "$new_status" ]; then
            echo "Status unchanged ($new_status). Skipping publish."
            exit 0
          fi

          mkdir -p health
          cp health_out/index.html health/index.html
          cp health_out/status.json health/status.json

          git add health/index.html health/status.json
          if git diff --cached --quiet; then
            echo "No changes to publish."
            exit 0
          fi

          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git commit -m "healthcheck(${new_status}): update status page"
          git push origin gh-pages

      - name: Find downtime issues
        id: downtime_issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          issues_json=$(gh api -X GET "search/issues" -f q="repo:${GITHUB_REPOSITORY} is:issue is:open label:downtime in:title [HEALTHCHECK]" -f per_page=100)
          count=$(jq '.total_count // 0' <<<"$issues_json")
          first_number=$(jq '.items[0].number // empty' <<<"$issues_json")
          numbers=$(jq -r '.items[].number' <<<"$issues_json" | paste -sd, -)

          echo "count=${count}" >> "$GITHUB_OUTPUT"
          echo "first_number=${first_number}" >> "$GITHUB_OUTPUT"
          echo "numbers=${numbers}" >> "$GITHUB_OUTPUT"

      - name: Open downtime issue
        if: steps.health_status.outputs.status == 'FAIL' && steps.downtime_issues.outputs.count == '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          gh api "repos/${GITHUB_REPOSITORY}/issues" \
            -f title="[HEALTHCHECK] Downtime detected: health checks failing" \
            -f body="@nipreps/webapi\n\nHealth check failing: https://www.nipreps.org/mriqcwebapi/health/" \
            -f labels='downtime'

      - name: Deduplicate downtime issues
        if: steps.health_status.outputs.status == 'FAIL' && steps.downtime_issues.outputs.count != '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          keep_number="${{ steps.downtime_issues.outputs.first_number }}"
          issue_numbers="${{ steps.downtime_issues.outputs.numbers }}"

          if [ -z "$issue_numbers" ] || [ "$issue_numbers" = "$keep_number" ]; then
            exit 0
          fi

          IFS=',' read -r -a issue_array <<< "$issue_numbers"
          for issue_number in "${issue_array[@]}"; do
            if [ "$issue_number" = "$keep_number" ]; then
              continue
            fi
            gh api "repos/${GITHUB_REPOSITORY}/issues/${issue_number}/comments" \
              -f body="Superseded by #${keep_number}."
            gh api "repos/${GITHUB_REPOSITORY}/issues/${issue_number}" \
              -X PATCH \
              -f state=closed
          done

      - name: Close downtime issue on recovery
        if: steps.health_status.outputs.status == 'OK' && steps.downtime_issues.outputs.count != '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          issue_numbers="${{ steps.downtime_issues.outputs.numbers }}"
          if [ -z "$issue_numbers" ]; then
            exit 0
          fi

          IFS=',' read -r -a issue_array <<< "$issue_numbers"
          for issue_number in "${issue_array[@]}"; do
            gh api "repos/${GITHUB_REPOSITORY}/issues/${issue_number}/comments" \
              -f body="Recovered. Health check: https://www.nipreps.org/mriqcwebapi/health/."
            gh api "repos/${GITHUB_REPOSITORY}/issues/${issue_number}" \
              -X PATCH \
              -f state=closed
          done
