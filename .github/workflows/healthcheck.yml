name: Healthcheck

"on":
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  probe:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Probe endpoints
        env:
          API_TOKEN: ${{ secrets.API_TOKEN }}
        run: |
          set -euo pipefail

          auth_header=()
          if [ -n "${API_TOKEN:-}" ]; then
            auth_header=( -H "Authorization: Bearer ${API_TOKEN}" )
          fi

          probe() {
            local name=$1
            local url=$2
            local result
            result=$(curl -sS -o /dev/null -w "%{http_code} %{time_total}" "${auth_header[@]}" "$url" || true)
            local code time
            code=$(awk '{print $1}' <<<"$result")
            time=$(awk '{print $2}' <<<"$result")
            if [ -z "$code" ]; then
              code="000"
              time="0"
            fi
            printf '%s|%s|%s\n' "$name" "$code" "$time"
          }

          mkdir -p health_out
          {
            probe "swagger" "https://mriqc.nimh.nih.gov/"
            probe "t1w" "https://mriqc.nimh.nih.gov/api/v1/T1w"
            probe "bold" "https://mriqc.nimh.nih.gov/api/v1/bold"
          } > health_out/raw.txt

          python test/healthcheck_status.py health_out/raw.txt health_out/status.json
          python test/healthcheck_render.py health_out/status.json health_out/index.html

      - name: Publish to gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          git fetch origin gh-pages || true
          if git show-ref --quiet refs/remotes/origin/gh-pages; then
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf .
          fi

          mkdir -p health
          cp health_out/index.html health/index.html
          cp health_out/status.json health/status.json

          git add health/index.html health/status.json
          if git diff --cached --quiet; then
            echo "No changes to publish."
            exit 0
          fi

          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git commit -m "chore(healthcheck): update status page"
          git push origin gh-pages
